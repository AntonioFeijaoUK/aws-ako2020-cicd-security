{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "AWS AKO 2020 session",

  "Resources": {
    "VPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": "10.0.0.0/16"
      }
    },
    "Subnet": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref":"VPC" },
        "CidrBlock": "10.0.0.0/24"
      }
    },
    "InternetGateway": {
     "Type": "AWS::EC2::InternetGateway"
    },
    "InternetGatewayAttachment": {
     "Type": "AWS::EC2::VPCGatewayAttachment",
     "Properties": {
       "VpcId": {"Ref":"VPC"},
       "InternetGatewayId": {"Ref":"InternetGateway"}
     }
   },
   "RouteTable": {
     "Type": "AWS::EC2::RouteTable",
     "Properties": {
       "VpcId": {"Ref":"VPC"}
     }
   },
   "Route": {
     "Type": "AWS::EC2::Route",
     "DependsOn": "InternetGatewayAttachment",
     "Properties": {
       "RouteTableId": {"Ref":"RouteTable"},
       "DestinationCidrBlock": "0.0.0.0/0",
       "GatewayId": {"Ref":"InternetGateway"}
    }
  },
  "SubnetRouteTableAssociation": {
    "Type": "AWS::EC2::SubnetRouteTableAssociation",
    "Properties": {
      "RouteTableId": {"Ref":"RouteTable"},
      "SubnetId": {"Ref":"Subnet"}
    }
  },
  "IpAddress": {
    "Type": "AWS::EC2::EIP",
    "DependsOn": "InternetGatewayAttachment",
    "Properties": {
      "Domain": "vpc",
      "InstanceId": { "Ref": "Jenkins" }
    }
  },
  "JenkinsSecurityGroup" : {
   "Type": "AWS::EC2::SecurityGroup",
   "Properties": {
     "VpcId": {"Ref":"VPC"},
     "GroupDescription":"Enable access to Jenkins",
     "SecurityGroupIngress": [
       {"IpProtocol": "tcp", "FromPort": "8080", "ToPort": "8080", "CidrIp": "0.0.0.0/0"},
       {"IpProtocol": "tcp", "FromPort": "22", "ToPort": "22", "CidrIp": "0.0.0.0/0"}
     ]
   }
  },
  "Jenkins" : {
    "Type": "AWS::EC2::Instance",
    "DependsOn": "InternetGatewayAttachment",
    "Properties": {
      "ImageId": "ami-0ae7bf40f7742b238",
      "InstanceType": "m5.large",
      "KeyName": "tko20",
      "NetworkInterfaces": [{
        "GroupSet": [{"Ref":"JenkinsSecurityGroup"}],
        "AssociatePublicIpAddress": "true",
        "DeviceIndex": "0",
        "DeleteOnTermination": "true",
        "SubnetId": {"Ref": "Subnet"}
      }],
      "UserData": {
        "Fn::Base64": {
          "Fn::Join": [
           "", [
	      "#!/bin/bash \n",
	      "sudo yum update -y && sudo su -s /bin/bash jenkins && ssh -o StrictHostKeychecking=no git@github.com && sudo yum install -y java-1.8.0-openjdk-devel && sudo service jenkins start"
           ]]
            }
        }
      }
  },
  "BuildArtifacts" : {
    "Type" : "AWS::S3::Bucket"
  },
  "JenkinsIAMRole" : {
    "Type" : "AWS::IAM::Role",
    "Properties" : {
      "AssumeRolePolicyDocument" : {
        "Version": "2012-10-17",
        "Statement": [{
          "Effect": "Allow",
          "Principal": {
            "Service": ["ec2.amazonaws.com"]
          },
          "Action": ["sts:AssumeRole"]
        }]
      }
    }
  },
  "BuildArtifactsIAMPolicy" : {
    "Type" : "AWS::IAM::Policy",
    "Properties" : {
      "PolicyName" : "jenkins-buildartifacts",
      "PolicyDocument" : {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": ["s3:GetObject","s3:PutObject"],
            "Resource": [{
              "Fn::Join" : [ "", [
                "arn:aws:s3:::", {
                  "Ref" : "BuildArtifacts"
                },
                "/*"
              ]]
            }]
          }
        ]
      },
      "Roles" :[{"Ref": "JenkinsIAMRole"}]
    }
  },
  "JenkinsIAMInstanceProfile" : {
    "Type" : "AWS::IAM::InstanceProfile",
    "Properties" : {
      "Path" : "/",
      "Roles" : [{ "Ref" : "JenkinsIAMRole" }]
    }
  }
 }
}